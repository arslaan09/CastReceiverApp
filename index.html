<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Screen Mirror Receiver</title>
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <!-- JMuxer for low-latency raw H.264 playback via WebSocket -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jmuxer@2.0.4/dist/jmuxer.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    #splash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 10;
    }

    .logo {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .logo svg {
      width: 60px;
      height: 60px;
      fill: white;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .subtitle {
      font-size: 24px;
      opacity: 0.8;
      margin-bottom: 50px;
    }

    .status-container {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      backdrop-filter: blur(10px);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      background: #fbbf24;
      border-radius: 50%;
      animation: blink 1.5s ease-in-out infinite;
    }

    .status-dot.connected {
      background: #4ade80;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    .status-text {
      font-size: 20px;
    }

    #video-player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
      display: none;
      z-index: 5;
    }

    .audio-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      z-index: 20;
    }

    .audio-icon-large {
      font-size: 120px;
      margin-bottom: 30px;
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .audio-time {
      font-size: 32px;
      color: white;
      font-family: monospace;
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 20px;
      border-radius: 15px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div id="splash">
    <div class="logo">
      <svg viewBox="0 0 24 24">
        <path
          d="M21,3H3C1.89,3 1,3.89 1,5V17A2,2 0 0,0 3,19H8V21H16V19H21A2,2 0 0,0 23,17V5C23,3.89 22.1,3 21,3M21,17H3V5H21M16,11L9,15V7" />
      </svg>
    </div>
    <div class="title">Screen Mirroring -Miracast</div>
    <div class="subtitle" id="connectionMessage">Waiting for connection...</div>
    <div class="status-container">
      <div class="status-dot" id="statusDot"></div>
      <div class="status-text" id="statusText">Ready to receive</div>
    </div>
  </div>

  <div id="audio-ui" class="audio-container hidden">
    <div class="audio-icon-large">ðŸŽµ</div>
    <div class="title" style="margin-bottom: 10px;">Playing Audio</div>
    <div class="audio-time" id="audioTimeDisplay">00:00 / 00:00</div>
  </div>

  <video id="video-player" autoplay playsinline muted></video>
  <video id="media-player" class="hidden"
    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 7; background: black;"></video>
  <img id="image-viewer" class="hidden"
    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 6; background: black;">

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        const splash = document.getElementById('splash');
        const videoPlayer = document.getElementById('video-player');
        const mediaPlayer = document.getElementById('media-player');
        const imageViewer = document.getElementById('image-viewer');
        const audioUI = document.getElementById('audio-ui');
        const audioTimeDisplay = document.getElementById('audioTimeDisplay');

        const connectionMessage = document.getElementById('connectionMessage');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        const NAMESPACE = 'urn:x-cast:com.tvmirror.screenmirror';

        let jmuxer = null;
        let ws = null;

        // Initialize JMuxer
        function initJMuxer() {
          if (jmuxer) return;
          if (typeof JMuxer === 'undefined') {
            console.error("JMuxer library not loaded!");
            return;
          }
          jmuxer = new JMuxer({
            node: 'video-player',
            mode: 'video',
            flushingTime: 0,
            clearBuffer: true,
            fps: 30,
            debug: false,
            onError: function (data) {
              console.error('Buffer error:', data);
            }
          });
        }

        // Handle custom messages from sender
        context.addCustomMessageListener(NAMESPACE, (event) => {
          console.log('Received message:', event.data);

          let data = event.data;
          if (typeof data === 'string') {
            try {
              data = JSON.parse(data);
            } catch (e) {
              console.error('Failed to parse message:', e);
              return;
            }
          }

          if (data.type === 'CONNECTION_ESTABLISHED') {
            connectionMessage.textContent = 'Connected to ' + (data.deviceName || 'iOS Device');
            statusText.textContent = 'Connection established';
            statusDot.classList.add('connected');
          }

          if (data.type === 'START_MIRRORING') {
            stopImageCasting();
            stopMediaCasting();
            const wsUrl = data.streamUrl;
            if (wsUrl) {
              startMirroring(wsUrl);
            }
          }

          if (data.type === 'STOP_MIRRORING') {
            stopMirroring();
          }

          if (data.type === 'CAST_IMAGE_WS') {
            cleanupMirroringConnection();
            stopMediaCasting();

            startMirroring(data.streamUrl);

            videoPlayer.style.display = 'none';
            imageViewer.classList.remove('hidden');
            imageViewer.style.display = 'block';
            statusText.textContent = 'Waiting for Image...';
          }

          if (data.type === 'CAST_VIDEO') {
            cleanupMirroringConnection();
            stopImageCasting();
            stopMediaCasting();
            playVideo(data.videoUrl);
          }

          if (data.type === 'CAST_AUDIO') {
            cleanupMirroringConnection();
            stopImageCasting();
            playAudio(data.audioUrl);
          }

          if (data.type === 'MEDIA_CONTROL') {
            handleMediaControl(data.command, data.value);
          }
        });

        function playVideo(url) {
          console.log("Playing video: ", url);
          splash.classList.add('hidden');
          audioUI.classList.add('hidden');

          mediaPlayer.classList.remove('hidden');
          mediaPlayer.style.display = 'block';

          mediaPlayer.src = url;
          mediaPlayer.play().catch(e => console.error("Play video failed", e));
          statusText.textContent = 'Playing Video';
          videoPlayer.style.display = 'none';
        }

        function playAudio(url) {
          console.log("Playing audio: ", url);
          splash.classList.add('hidden');
          audioUI.classList.remove('hidden');

          mediaPlayer.src = url;
          mediaPlayer.play().catch(e => console.error("Play audio failed", e));

          statusText.textContent = 'Playing Audio';
          videoPlayer.style.display = 'none';
        }

        mediaPlayer.ontimeupdate = function () {
          if (!audioUI.classList.contains('hidden')) {
            const current = formatTime(mediaPlayer.currentTime);
            const duration = formatTime(mediaPlayer.duration);
            audioTimeDisplay.textContent = current + " / " + duration;
          }
        };

        function formatTime(seconds) {
          if (isNaN(seconds)) return "00:00";
          let m = Math.floor(seconds / 60);
          let s = Math.floor(seconds % 60);
          return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
        }

        function handleMediaControl(command, value) {
          if (!mediaPlayer) return;
          switch (command) {
            case 'play': mediaPlayer.play(); break;
            case 'pause': mediaPlayer.pause(); break;
            case 'seek': mediaPlayer.currentTime += value; break;
            case 'seekTo': mediaPlayer.currentTime = value; break;
            case 'vol_up': mediaPlayer.volume = Math.min(1, mediaPlayer.volume + 0.1); break;
            case 'vol_down': mediaPlayer.volume = Math.max(0, mediaPlayer.volume - 0.1); break;
          }
        }

        function stopMediaCasting() {
          mediaPlayer.pause();
          mediaPlayer.src = "";
          mediaPlayer.classList.add('hidden');
          mediaPlayer.style.display = 'none';
          mediaPlayer.removeAttribute('src');
          audioUI.classList.add('hidden');
        }

        function showImageBlob(blob) {
          let url = URL.createObjectURL(blob);
          imageViewer.onload = () => { URL.revokeObjectURL(url); };
          imageViewer.src = url;

          if (!splash.classList.contains('hidden')) splash.classList.add('hidden');
          if (videoPlayer.style.display !== 'none') videoPlayer.style.display = 'none';
          audioUI.classList.add('hidden');

          imageViewer.style.display = 'block';
          if (imageViewer.classList.contains('hidden')) imageViewer.classList.remove('hidden');
          if (statusText.textContent !== 'Showing Image') statusText.textContent = 'Showing Image';
        }

        function startMirroring(url) {
          console.log('Connecting to WS:', url);
          initJMuxer();
          if (ws) ws.close();

          ws = new WebSocket(url);
          ws.binaryType = 'arraybuffer';
          ws.onopen = () => { statusText.textContent = 'Connected'; };
          ws.onmessage = (event) => {
            let data = new Uint8Array(event.data);
            if (data.length > 2 && data[0] === 0xFF && data[1] === 0xD8) {
              showImageBlob(new Blob([data], { type: 'image/jpeg' }));
            } else {
              if (videoPlayer.style.display === 'none') {
                videoPlayer.style.display = 'block';
                imageViewer.classList.add('hidden');
                imageViewer.style.display = 'none';
                splash.classList.add('hidden');
                audioUI.classList.add('hidden');
                statusText.textContent = 'Mirroring Screen';
              }
              if (jmuxer) jmuxer.feed({ video: data });
            }
          };
          ws.onerror = (e) => console.error('WS error:', e);
          ws.onclose = () => console.log('WS closed');
        }

        function stopImageCasting() {
          imageViewer.classList.add('hidden');
          imageViewer.style.display = 'none';
          imageViewer.src = "";
        }

        function cleanupMirroringConnection() {
          if (ws) { ws.close(); ws = null; }
          if (jmuxer) { jmuxer.destroy(); jmuxer = null; }
        }

        function stopMirroring() {
          cleanupMirroringConnection();
          stopMediaCasting();
          stopImageCasting();
          videoPlayer.style.display = 'none';
          audioUI.classList.add('hidden');
          splash.classList.remove('hidden');
          statusText.textContent = 'Ready to receive';
        }

        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        options.maxInactivity = 3600;
        context.start(options);

      } catch (err) {
        console.error("Critical receiver error:", err);
      }
    });

</body >

</html >